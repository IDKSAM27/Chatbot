<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management - Campus Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50" x-data="documentManager()">

<div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Document Management</h1>
        <p class="text-gray-600">Upload and manage campus documents for AI knowledge base</p>
    </div>

    <!-- Add this button after the upload section -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Testing Tools</h3>
        <p class="text-sm text-yellow-700 mb-3">For testing: Clear all existing knowledge base data before uploading new documents</p>
        <form action="/admin/clear_knowledge_base" method="POST" style="display: inline;">
            <button type="submit" 
                    onclick="return confirm('Are you sure you want to clear all stored documents?')"
                    class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                üóëÔ∏è Clear Knowledge Base
            </button>
        </form>
    </div>


    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-800">{{ stats.total_documents }}</p>
                    <p class="text-sm text-gray-600">Total FAQs</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-800">{{ stats.categories|length }}</p>
                    <p class="text-sm text-gray-600">Categories</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a.75.75 0 01-.748-.721L8.77 5H7.5A1.5 1.5 0 006 6.5v3A1.5 1.5 0 007.5 11h1.043a.75.75 0 01.748.721l.058.779H12a1 1 0 110 2H9.421a.75.75 0 01-.748-.721L8.615 13H7.5A1.5 1.5 0 016 11.5v-3A1.5 1.5 0 017.5 7h1.043a.75.75 0 01.748.721L9.349 8H12a1 1 0 110 2H9.578a.75.75 0 01-.748-.721L8.77 9H7.5A1.5 1.5 0 016 7.5v-3A1.5 1.5 0 017.5 4h1.043a.75.75 0 01.748.721L9.349 5H12a1 1 0 110 2H9.578a.75.75 0 01-.748-.721L8.77 6H7a1 1 0 01-1-1V3a1 1 0 011-1z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-800">{{ stats.languages|length }}</p>
                    <p class="text-sm text-gray-600">Languages</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-800">{{ stats.total_chunks or 0 }}</p>
                    <p class="text-sm text-gray-600">Content Chunks</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <!-- BULK UPLOAD SECTION -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÅ Upload Documents (Bulk Upload Supported)</h2>

        <form action="/admin/upload_documents" method="POST" enctype="multipart/form-data" 
              x-data="bulkUpload()" @submit.prevent="uploadFiles()" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Select PDF Documents (Multiple files supported)
                </label>
                <div class="flex items-center space-x-4">
                    <input type="file" name="files" accept=".pdf,.docx,.txt" multiple
                           x-ref="fileInput" @change="handleFileSelection()"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button type="submit" :disabled="uploading || selectedFiles.length === 0"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!uploading">üì§ Upload & Process</span>
                        <span x-show="uploading">‚è≥ Processing...</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Supported: PDF, DOCX, TXT ‚Ä¢ <strong>Multiple files allowed</strong>
                </p>
            </div>

            <!-- File List Display -->
            <div x-show="selectedFiles.length > 0" class="mt-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Selected Files:</p>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    <template x-for="(file, index) in selectedFiles" :key="index">
                        <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                            <span class="text-sm" x-text="file.name"></span>
                            <span class="text-xs text-gray-500" x-text="(file.size / 1024 / 1024).toFixed(1) + ' MB'"></span>
                            <button @click="removeFile(index)" type="button" class="text-red-500 hover:text-red-700">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"></path>
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>
                <p class="text-xs text-blue-600 mt-1" x-text="`${selectedFiles.length} files selected`"></p>
            </div>

            <!-- Progress Indicator -->
            <div x-show="uploading" class="mt-4">
                <div class="flex items-center space-x-3">
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                             :style="`width: ${uploadProgress}%`"></div>
                    </div>
                    <span class="text-sm text-gray-600" x-text="`${uploadProgress}%`"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1" x-text="currentStatus"></p>
            </div>
        </form>
    </div>

    <script>
    function bulkUpload() {
        return {
            selectedFiles: [],
            uploading: false,
            uploadProgress: 0,
            currentStatus: '',

            handleFileSelection() {
                const files = Array.from(this.$refs.fileInput.files);
                this.selectedFiles = files.filter(file => {
                    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
                    return validTypes.includes(file.type) && file.size < 50 * 1024 * 1024; // 50MB limit
                });
            },

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                const dt = new DataTransfer();
                this.selectedFiles.forEach(file => dt.items.add(file));
                this.$refs.fileInput.files = dt.files;
            },

            async uploadFiles() {
                if (this.selectedFiles.length === 0) return;

                this.uploading = true;
                this.uploadProgress = 0;
                this.currentStatus = 'Preparing files...';

                const formData = new FormData();
                this.selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                try {
                    const response = await fetch('/admin/upload_documents', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.uploadProgress = 100;
                        this.currentStatus = 'Upload complete!';
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    this.currentStatus = 'Upload failed. Please try again.';
                    console.error('Upload error:', error);
                } finally {
                    this.uploading = false;
                }
            }
        }
    }
    </script>


        <!-- Back to Chat -->
        <div class="text-center mt-8">
            <a href="/chat" class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0L2.586 11H16a1 1 0 110 2H2.586l3.707 3.707a1 1 0 11-1.414 1.414l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L3.414 9H16a1 1 0 110 2H7.707z"></path>
                </svg>
                Test Enhanced Chatbot
            </a>
        </div>
    </div>

<script>
function documentManager() {
    return {
        async searchDocs() {
            if (!this.searchQuery.trim()) return;
            
            this.loading = true;
            try {
                const response = await fetch(`/api/v1/search_documents?q=${encodeURIComponent(this.searchQuery)}`);
                const data = await response.json();
                this.searchResults = data.results || [];
            } catch (error) {
                console.error('Search error:', error);
                this.searchResults = [];
            }
            this.loading = false;
        }
    }
}
</script>

</body>
</html>
